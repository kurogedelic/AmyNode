<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AmyNode Web Preview Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #1e1e1e;
            color: #fff;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #ff6600;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #ff8533;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
        }
        .success { background: rgba(76, 175, 80, 0.2); }
        .error { background: rgba(244, 67, 54, 0.2); }
        .info { background: rgba(33, 150, 243, 0.2); }
        .log {
            background: #2d2d2d;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>AmyNode Web Preview Test</h1>
    
    <div class="test-section">
        <h2>Audio Engine Test</h2>
        <button onclick="testAudioEngine()">Test WebAudio Engine</button>
        <button onclick="testAMYWASM()">Test AMY WASM</button>
        <button onclick="stopAll()">Stop All</button>
        <div id="engine-status"></div>
    </div>
    
    <div class="test-section">
        <h2>Node Connection Test</h2>
        <button onclick="testBasicConnection()">Test Oscillator ‚Üí Output</button>
        <button onclick="testComplexConnection()">Test Oscillator ‚Üí Filter ‚Üí Output</button>
        <div id="connection-status"></div>
    </div>
    
    <div class="test-section">
        <h2>Console Log</h2>
        <div id="console-log" class="log"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <script type="module">
        import { AudioEngine } from './src/audio/engine.js';
        
        let audioEngine = null;
        let testNodes = [];
        
        // Redirect console.log to our display
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function logToDisplay(message, type = 'log') {
            const logDiv = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        console.log = (...args) => {
            originalLog(...args);
            logToDisplay(args.join(' '), 'log');
        };
        
        console.error = (...args) => {
            originalError(...args);
            logToDisplay(args.join(' '), 'error');
        };
        
        console.warn = (...args) => {
            originalWarn(...args);
            logToDisplay(args.join(' '), 'warn');
        };
        
        // Test functions
        window.testAudioEngine = async function() {
            const statusDiv = document.getElementById('engine-status');
            statusDiv.innerHTML = '<div class="status info">Initializing Audio Engine...</div>';
            
            try {
                audioEngine = new AudioEngine();
                await audioEngine.start();
                
                statusDiv.innerHTML = `
                    <div class="status success">‚úÖ Audio Engine initialized</div>
                    <div>AMY WASM initialized: ${audioEngine.amyInitialized}</div>
                    <div>Audio Context state: ${audioEngine.context.state}</div>
                    <div>Sample Rate: ${audioEngine.context.sampleRate} Hz</div>
                `;
                
                console.log('Audio Engine test passed');
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Audio Engine failed: ${error.message}</div>`;
                console.error('Audio Engine test failed:', error);
            }
        };
        
        window.testAMYWASM = async function() {
            const statusDiv = document.getElementById('engine-status');
            
            if (!audioEngine) {
                statusDiv.innerHTML = '<div class="status error">‚ùå Initialize Audio Engine first</div>';
                return;
            }
            
            statusDiv.innerHTML = '<div class="status info">Testing AMY WASM integration...</div>';
            
            try {
                const info = audioEngine.amyInitialized;
                if (info) {
                    statusDiv.innerHTML = '<div class="status success">‚úÖ AMY WASM is working</div>';
                } else {
                    statusDiv.innerHTML = '<div class="status error">‚ùå AMY WASM not initialized</div>';
                }
                
                console.log('AMY WASM test completed');
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå AMY WASM test failed: ${error.message}</div>`;
                console.error('AMY WASM test error:', error);
            }
        };
        
        window.testBasicConnection = async function() {
            const statusDiv = document.getElementById('connection-status');
            statusDiv.innerHTML = '<div class="status info">Testing basic Oscillator ‚Üí Output connection...</div>';
            
            if (!audioEngine) {
                statusDiv.innerHTML = '<div class="status error">‚ùå Initialize Audio Engine first</div>';
                return;
            }
            
            try {
                // Create mock graph with oscillator and output
                const mockGraph = {
                    _nodes: [
                        {
                            id: 1,
                            type: 'amy/oscillator',
                            title: 'Test Oscillator',
                            properties: {
                                wave_type: 'SINE',
                                frequency: 440,
                                amplitude: 0.3,
                                filter_type: 'NONE'
                            },
                            getInputData: () => undefined
                        },
                        {
                            id: 2,
                            type: 'amy/output',
                            title: 'Test Output',
                            properties: {
                                master_volume: 0.5,
                                stereo_mode: false
                            }
                        }
                    ],
                    links: {
                        1: {
                            id: 1,
                            origin_id: 1,
                            origin_slot: 0,
                            target_id: 2,
                            target_slot: 0,
                            type: 'audio'
                        }
                    }
                };
                
                // Update from mock graph
                audioEngine.updateFromGraph(mockGraph);
                
                console.log('Created oscillator and output nodes');
                console.log('Audio nodes:', audioEngine.nodes.size);
                
                statusDiv.innerHTML = `
                    <div class="status success">‚úÖ Basic connection test completed</div>
                    <div>Nodes created: ${audioEngine.nodes.size}</div>
                    <div>Should be playing 440Hz sine wave for 3 seconds...</div>
                `;
                
                // Stop after 3 seconds
                setTimeout(() => {
                    audioEngine.stop();
                    statusDiv.innerHTML += '<div class="status info">üîá Audio stopped</div>';
                }, 3000);
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Connection test failed: ${error.message}</div>`;
                console.error('Connection test error:', error);
            }
        };
        
        window.testComplexConnection = async function() {
            const statusDiv = document.getElementById('connection-status');
            statusDiv.innerHTML = '<div class="status info">Testing Oscillator ‚Üí Filter ‚Üí Output chain...</div>';
            
            if (!audioEngine) {
                statusDiv.innerHTML = '<div class="status error">‚ùå Initialize Audio Engine first</div>';
                return;
            }
            
            try {
                // Create mock graph with oscillator, filter, and output
                const mockGraph = {
                    _nodes: [
                        {
                            id: 1,
                            type: 'amy/oscillator',
                            title: 'Test Oscillator',
                            properties: {
                                wave_type: 'SAW_DOWN',
                                frequency: 220,
                                amplitude: 0.4,
                                filter_type: 'NONE'
                            },
                            getInputData: () => undefined
                        },
                        {
                            id: 2,
                            type: 'amy/filter',
                            title: 'Test Filter',
                            properties: {
                                filter_type: 'LPF',
                                frequency: 800,
                                resonance: 2.0
                            }
                        },
                        {
                            id: 3,
                            type: 'amy/output',
                            title: 'Test Output',
                            properties: {
                                master_volume: 0.6,
                                stereo_mode: false
                            }
                        }
                    ],
                    links: {
                        1: {
                            id: 1,
                            origin_id: 1,
                            origin_slot: 0,
                            target_id: 2,
                            target_slot: 0,
                            type: 'audio'
                        },
                        2: {
                            id: 2,
                            origin_id: 2,
                            origin_slot: 0,
                            target_id: 3,
                            target_slot: 0,
                            type: 'audio'
                        }
                    }
                };
                
                // Update from mock graph
                audioEngine.updateFromGraph(mockGraph);
                
                console.log('Created oscillator ‚Üí filter ‚Üí output chain');
                
                statusDiv.innerHTML = `
                    <div class="status success">‚úÖ Complex connection test completed</div>
                    <div>Chain: Sawtooth ‚Üí LPF(800Hz) ‚Üí Output</div>
                    <div>Should be playing filtered sawtooth for 4 seconds...</div>
                `;
                
                // Stop after 4 seconds
                setTimeout(() => {
                    audioEngine.stop();
                    statusDiv.innerHTML += '<div class="status info">üîá Audio stopped</div>';
                }, 4000);
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Complex connection test failed: ${error.message}</div>`;
                console.error('Complex connection test error:', error);
            }
        };
        
        window.stopAll = function() {
            if (audioEngine) {
                audioEngine.stop();
                console.log('All audio stopped');
            }
        };
        
        window.clearLog = function() {
            document.getElementById('console-log').textContent = '';
        };
        
        // Initialize
        console.log('AmyNode Web Preview Test loaded');
    </script>
</body>
</html>